<!-- user-management.component.html -->
<div class="user-container">
  <div class="page-header">
    <h2 class="page-title">User Management</h2>
    <button class="btn-add" (click)="openAddModal()">
      <i class="icon-plus"></i> Add User
    </button>
  </div>

  <div class="search-section">
    <h3 class="search-title">Search</h3>
    <div class="search-filters">
      <input 
        type="text" 
        placeholder="Name" 
        [(ngModel)]="searchFilters.name"
        (ngModelChange)="onSearchChange()"
        class="search-input"
      />
      <input 
        type="text" 
        placeholder="Username" 
        [(ngModel)]="searchFilters.username"
        (ngModelChange)="onSearchChange()"
        class="search-input"
      />
      <input 
        type="text" 
        placeholder="Email" 
        [(ngModel)]="searchFilters.email"
        (ngModelChange)="onSearchChange()"
        class="search-input"
      />
      <input 
        type="text" 
        placeholder="Department" 
        [(ngModel)]="searchFilters.department"
        (ngModelChange)="onSearchChange()"
        class="search-input"
      />
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="(isLoading$ | async) && !(showModal$ | async)" class="loading-container">
    <div class="spinner"></div>
    <p>Loading users...</p>
  </div>

  <!-- Success/Error Messages -->
  <div class="alert-banner alert-success" *ngIf="(successMessage$ | async) && !(showModal$ | async)">
    {{ successMessage$ | async }}
  </div>

  <div class="alert-banner alert-error" *ngIf="(errorMessage$ | async) && !(showModal$ | async)">
    {{ errorMessage$ | async }}
  </div>

  <div class="table-container" *ngIf="!(isLoading$ | async) || (showModal$ | async)">
    <table class="users-table">
      <thead>
        <tr>
          <th>NAME</th>
          <th>USERNAME</th>
          <th>EMAIL</th>
          <th>DEPARTMENT</th>
          <th>ROLE</th>
          <th>STATUS</th>
          <th>CREATED</th>
          <th class="actions-column"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers$ | async" [class.inactive]="!user.isActive">
          <td>
            <div class="user-name">
              <div class="avatar">{{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}</div>
              <span>{{ user.firstName }} {{ user.lastName }}</span>
            </div>
          </td>
          <td>{{ user.username }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.department || '-' }}</td>
          <td>
            <span class="badge" [class.badge-admin]="user.role === 'Admin'">
              {{ user.role }}
            </span>
          </td>
          <td>
            <span class="status-badge" [class.status-active]="user.isActive" [class.status-inactive]="!user.isActive">
              {{ user.isActive ? 'Active' : 'Inactive' }}
            </span>
          </td>
          <td>{{ user.dateCreated | date:'MMM d, y' }}</td>
          <td class="actions-cell">
            <div class="action-buttons">
              <button 
                class="btn-icon btn-icon-edit" 
                (click)="openEditModal(user)"
                title="Edit User"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button 
                class="btn-icon btn-icon-toggle" 
                (click)="toggleUserStatus(user)"
                [title]="user.isActive ? 'Deactivate' : 'Activate'"
              >
                <svg *ngIf="user.isActive" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                </svg>
                <svg *ngIf="!user.isActive" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </button>
              <button 
                class="btn-icon btn-icon-delete" 
                (click)="deleteUser(user.userId, user.username)"
                title="Delete User"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="(filteredUsers$ | async)?.length === 0">
          <td colspan="8" class="no-data">No users found</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" *ngIf="showModal$ | async" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ (isEditMode$ | async) ? 'Edit User' : 'Add New User' }}</h2>
        <button class="btn-close" (click)="closeModal()">
          <i class="icon-close"></i>
        </button>
      </div>

      <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <!-- Success/Error Messages in Modal -->
          <div class="alert-banner alert-success" *ngIf="successMessage$ | async">
            {{ successMessage$ | async }}
          </div>

          <div class="alert-banner alert-error" *ngIf="errorMessage$ | async">
            {{ errorMessage$ | async }}
          </div>

          <!-- Personal Information Section -->
          <div class="form-section">
            <h3 class="section-title">Personal Information</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name <span class="required">*</span></label>
                <input 
                  type="text" 
                  id="firstName" 
                  formControlName="firstName" 
                  class="form-control"
                  [class.invalid]="firstName?.invalid && firstName?.touched" 
                  placeholder="Enter first name"
                />
                <span class="error-message" *ngIf="firstName?.invalid && firstName?.touched">
                  <span *ngIf="firstName?.errors?.['required']">First name is required</span>
                  <span *ngIf="firstName?.errors?.['minlength']">Must be at least 2 characters</span>
                  <span *ngIf="firstName?.errors?.['pattern']">Only letters, spaces, hyphens and apostrophes allowed</span>
                </span>
              </div>

              <div class="form-group">
                <label for="lastName">Last Name <span class="required">*</span></label>
                <input 
                  type="text" 
                  id="lastName" 
                  formControlName="lastName" 
                  class="form-control"
                  [class.invalid]="lastName?.invalid && lastName?.touched" 
                  placeholder="Enter last name"
                />
                <span class="error-message" *ngIf="lastName?.invalid && lastName?.touched">
                  <span *ngIf="lastName?.errors?.['required']">Last name is required</span>
                  <span *ngIf="lastName?.errors?.['minlength']">Must be at least 2 characters</span>
                  <span *ngIf="lastName?.errors?.['pattern']">Only letters, spaces, hyphens and apostrophes allowed</span>
                </span>
              </div>
            </div>

            <div class="form-group">
              <label for="email">Email Address <span class="required">*</span></label>
              <input 
                type="email" 
                id="email" 
                formControlName="email" 
                class="form-control"
                [class.invalid]="email?.invalid && email?.touched" 
                placeholder="Enter email address"
              />
              <span class="error-message" *ngIf="email?.invalid && email?.touched">
                <span *ngIf="email?.errors?.['required']">Email is required</span>
                <span *ngIf="email?.errors?.['email'] || email?.errors?.['pattern']">Please enter a valid email address</span>
              </span>
            </div>

            <div class="form-group">
              <label for="department">Department <span class="required">*</span></label>
              <select 
                id="department" 
                formControlName="department" 
                class="form-control"
                [class.invalid]="department?.invalid && department?.touched"
              >
                <option value="">Select department</option>
                <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
              </select>
              <span class="error-message" *ngIf="department?.invalid && department?.touched">
                <span *ngIf="department?.errors?.['required']">Please select a department</span>
              </span>
            </div>
          </div>

          <!-- Account Information Section -->
          <div class="form-section" *ngIf="!(isEditMode$ | async)">
            <h3 class="section-title">Account Information</h3>
            
            <div class="form-group">
              <label for="username">Username <span class="required">*</span></label>
              <input 
                type="text" 
                id="username" 
                formControlName="username" 
                class="form-control"
                [class.invalid]="username?.invalid && username?.touched" 
                placeholder="Enter username"
              />
              <span class="form-hint">4-20 characters. Letters, numbers and underscore only.</span>
              <span class="error-message" *ngIf="username?.invalid && username?.touched">
                <span *ngIf="username?.errors?.['required']">Username is required</span>
                <span *ngIf="username?.errors?.['minlength']">Must be at least 4 characters</span>
                <span *ngIf="username?.errors?.['maxlength']">Maximum 20 characters</span>
                <span *ngIf="username?.errors?.['pattern']">Only letters, numbers and underscore allowed</span>
              </span>
            </div>

            <div class="form-group">
              <label for="password">Password <span class="required">*</span></label>
              <div class="password-input-wrapper">
                <input 
                  [type]="(showPassword$ | async) ? 'text' : 'password'" 
                  id="password" 
                  formControlName="password"
                  class="form-control" 
                  [class.invalid]="password?.invalid && password?.touched"
                  placeholder="••••••••"
                />
                <button type="button" class="password-toggle" (click)="togglePasswordVisibility()" tabindex="-1">
                  <svg *ngIf="!(showPassword$ | async)" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg *ngIf="showPassword$ | async" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  </svg>
                </button>
              </div>
              <span class="form-hint">Must contain: uppercase, lowercase, number, special character (min 8 characters)</span>
              <span class="error-message" *ngIf="password?.invalid && password?.touched">
                <span *ngIf="password?.errors?.['required']">Password is required</span>
                <span *ngIf="password?.errors?.['minlength']">Must be at least 8 characters</span>
                <span *ngIf="password?.errors?.['passwordStrength']">Password must include uppercase, lowercase, number, and special character</span>
              </span>
            </div>

            <div class="form-group">
              <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
              <div class="password-input-wrapper">
                <input 
                  [type]="(showConfirmPassword$ | async) ? 'text' : 'password'" 
                  id="confirmPassword"
                  formControlName="confirmPassword" 
                  class="form-control"
                  [class.invalid]="(confirmPassword?.invalid && confirmPassword?.touched) || hasPasswordMismatch"
                  placeholder="••••••••"
                />
                <button type="button" class="password-toggle" (click)="toggleConfirmPasswordVisibility()" tabindex="-1">
                  <svg *ngIf="!(showConfirmPassword$ | async)" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg *ngIf="showConfirmPassword$ | async" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  </svg>
                </button>
              </div>
              <span class="error-message" *ngIf="confirmPassword?.invalid && confirmPassword?.touched">
                <span *ngIf="confirmPassword?.errors?.['required']">Please confirm your password</span>
              </span>
              <span class="error-message" *ngIf="hasPasswordMismatch">
                <span>Passwords do not match</span>
              </span>
            </div>

            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="acceptTerms" class="checkbox-input">
                <span>I agree to the <a href="/terms" target="_blank">Terms and Conditions</a> and 
                  <a href="/privacy" target="_blank">Privacy Policy</a>
                  <span class="required">*</span>
                </span>
              </label>
              <span class="error-message" *ngIf="acceptTerms?.invalid && acceptTerms?.touched">
                <span *ngIf="acceptTerms?.errors?.['required']">You must accept the terms and conditions</span>
              </span>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="closeModal()" [disabled]="isLoading$ | async">
            Cancel
          </button>
          <button type="submit" class="btn-submit" [disabled]="isLoading$ | async">
            <span *ngIf="!(isLoading$ | async)">{{ (isEditMode$ | async) ? 'Update User' : 'Create User' }}</span>
            <span *ngIf="isLoading$ | async" class="loading-spinner">
              <svg class="spinner" width="16" height="16" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>
                <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none"/>
              </svg>
              {{ (isEditMode$ | async) ? 'Updating...' : 'Creating...' }}
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>