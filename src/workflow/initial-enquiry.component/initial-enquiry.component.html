<div class="ie-container">

  <!-- ── Contextual source banners ──────────────────────────────────── -->
  <div class="context-banner context-banner--followup" *ngIf="fromFollowUp">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="banner-icon">
      <path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
      <line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/>
    </svg>
    <div>
      <strong>Opened from Follow-Up</strong> — this enquiry has been overdue for more than 3 days.
      Adding a new enquiry below will reset the follow-up timer automatically.
    </div>
  </div>

  <div class="context-banner context-banner--task" *ngIf="fromTask && !fromFollowUp">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="banner-icon">
      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
      <polyline points="22,6 12,13 2,6"/>
    </svg>
    <div>
      <strong>Opened from Email Task</strong> — the customer email below is pre-filled from the task sender address.
    </div>
  </div>

  <!-- ── Alerts ──────────────────────────────────────────────────────── -->
  <div class="alert alert-success" *ngIf="successMessage$ | async as msg">{{ msg }}</div>
  <div class="alert alert-error"   *ngIf="errorMessage$   | async as msg">{{ msg }}</div>

  <!-- ════════════════════════════════════════════════════════════════════
       SECTION 1 — CUSTOMER EMAILS
  ════════════════════════════════════════════════════════════════════════ -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title-row">
        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
        <h3 class="section-title">Customer Emails</h3>
        <span class="badge-count">{{ customerEmails.length }}</span>
      </div>
      <p class="section-subtitle">Emails linked to <strong>{{ customerName || 'this customer' }}</strong></p>
    </div>

    <div class="loading-row" *ngIf="isLoadingEmails$ | async">
      <div class="spinner"></div><span>Loading emails…</span>
    </div>

    <div class="table-wrapper" *ngIf="(isLoadingEmails$ | async) === false">
      <table class="data-table" *ngIf="customerEmails.length; else noEmails">
        <thead>
          <tr>
            <th>SUBJECT</th>
            <th>FROM</th>
            <th>TYPE</th>
            <th>PRIORITY</th>
            <th>STATUS</th>
            <th>DATE</th>
            <th class="col-actions">ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of customerEmails; trackBy: trackByEmail">
            <td class="col-subject" [title]="row.subject">{{ row.subject }}</td>
            <td class="col-from">
              <div class="from-name">{{ row.fromName }}</div>
              <div class="from-email">{{ row.fromEmail }}</div>
            </td>
            <td><span class="type-chip">{{ row.taskType || row.category }}</span></td>
            <td><span [class]="getPriorityClass(row.priority)">{{ row.priority }}</span></td>
            <td><span [class]="getStatusClass(row.status)">{{ row.status }}</span></td>
            <td class="col-date">{{ row.dateAdded | date:'dd MMM yyyy' }}</td>
            <td class="col-actions">
              <button class="btn-icon btn-view" title="View email" (click)="openEmailPreview(row)">
                <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5z"/><circle cx="8" cy="8" r="2"/>
                </svg>View
              </button>
              <button class="btn-icon btn-reply" title="Reply" (click)="openSendModal(row)">
                <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
                  <polyline points="14,2 2,8 14,14"/><polyline points="2,8 8,8 8,14"/>
                </svg>Reply
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <ng-template #noEmails>
        <div class="empty-state">
          <svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M8 12h48c2.2 0 4 1.8 4 4v32c0 2.2-1.8 4-4 4H8c-2.2 0-4-1.8-4-4V16c0-2.2 1.8-4 4-4z"/>
            <polyline points="60,16 32,36 4,16"/>
          </svg>
          <p>No emails found for this customer.</p>
        </div>
      </ng-template>
    </div>
  </div>


  <!-- ════════════════════════════════════════════════════════════════════
       SECTION 2 — ADD NEW ENQUIRY  (email field FIRST, then comments)
  ════════════════════════════════════════════════════════════════════════ -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title-row">
        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/>
          <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
        <h3 class="section-title">Add Enquiry</h3>
      </div>
    </div>

    <div class="add-form">
      <!-- Row 1: email first -->
      <div class="form-group">
        <label class="form-label">Customer Email</label>
        <input type="email" class="form-input"
          [(ngModel)]="newEmail"
          placeholder="customer@example.com"
          [disabled]="(isSaving$ | async) === true" />
      </div>

      <!-- Row 2: comments -->
      <div class="form-group" style="margin-top:14px;">
        <label class="form-label">Comments <span class="required">*</span></label>
        <textarea class="form-input form-textarea"
          [(ngModel)]="newComments"
          placeholder="Enter enquiry details…"
          rows="4"
          maxlength="2000"
          [disabled]="(isSaving$ | async) === true">
        </textarea>
        <span class="char-hint">{{ newComments.length }}/2000</span>
      </div>

      <div class="form-footer">
        <label class="checkbox-label">
          <input type="checkbox"
            [(ngModel)]="sendEmailOnAdd"
            [disabled]="!newEmail.trim() || (isSaving$ | async) === true" />
          <span>Send email notification to customer on save</span>
        </label>
        <button class="btn-primary"
          (click)="addEnquiry()"
          [disabled]="!newComments.trim() || (isSaving$ | async) === true">
          <svg *ngIf="(isSaving$ | async) === false" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.2">
            <line x1="8" y1="1" x2="8" y2="15"/><line x1="1" y1="8" x2="15" y2="8"/>
          </svg>
          <span *ngIf="(isSaving$ | async) === false">Add Enquiry</span>
          <span *ngIf="(isSaving$ | async) === true"><span class="spinner-inline"></span> Saving…</span>
        </button>
      </div>
    </div>
  </div>


  <!-- ════════════════════════════════════════════════════════════════════
       SECTION 3 — ENQUIRY HISTORY
  ════════════════════════════════════════════════════════════════════════ -->
  <div class="section-card">
    <div class="section-header">
      <div class="section-title-row">
        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        <h3 class="section-title">Enquiry History</h3>
        <span class="badge-count">{{ enquiries.length }}</span>
      </div>
    </div>

    <div class="loading-row" *ngIf="isLoadingEnquiries$ | async">
      <div class="spinner"></div><span>Loading enquiries…</span>
    </div>

    <div class="table-wrapper" *ngIf="(isLoadingEnquiries$ | async) === false">
      <table class="data-table" *ngIf="enquiries.length; else noEnquiries">
        <thead>
          <tr>
            <th>#</th>
            <th>EMAIL</th>
            <th>COMMENTS</th>
            <th>DATE ADDED</th>
            <th>ADDED BY</th>
            <th class="col-actions">ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let enq of enquiries; let i = index; trackBy: trackByEnquiry">
            <td class="col-index">{{ i + 1 }}</td>
            <td class="col-email-small">{{ enq.email }}</td>
            <td class="col-comments" [title]="enq.comments">{{ enq.comments }}</td>
            <td class="col-date">{{ enq.dateCreated | date:'dd MMM yyyy, HH:mm' }}</td>
            <td class="col-user">{{ enq.createdBy || '—' }}</td>
            <td class="col-actions">
              <button class="btn-icon btn-edit" title="Edit enquiry" (click)="openEditModal(enq)">
                <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
                  <path d="M11.5 2.5a1.414 1.414 0 012 2L5 13H2v-3L11.5 2.5z"/>
                </svg>Edit
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <ng-template #noEnquiries>
        <div class="empty-state">
          <svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 8h40a4 4 0 014 4v32a4 4 0 01-4 4H12a4 4 0 01-4-4V12a4 4 0 014-4z"/>
            <line x1="20" y1="24" x2="44" y2="24"/><line x1="20" y1="32" x2="44" y2="32"/>
            <line x1="20" y1="40" x2="32" y2="40"/>
          </svg>
          <p>No enquiries recorded yet. Add one above.</p>
        </div>
      </ng-template>
    </div>
  </div>

</div><!-- /ie-container -->


<!-- ══════════════════════════════════════════════════════════════════════
     MODAL — EMAIL PREVIEW
══════════════════════════════════════════════════════════════════════════ -->
<div class="modal-backdrop" *ngIf="showEmailModal" (click)="closeEmailPreview()">
  <div class="modal-card modal-card--lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" width="18" height="18">
          <path d="M3 4h14c.6 0 1 .4 1 1v10c0 .6-.4 1-1 1H3c-.6 0-1-.4-1-1V5c0-.6.4-1 1-1z"/>
        </svg>Email Detail
      </h3>
      <button class="modal-close" (click)="closeEmailPreview()">
        <svg viewBox="0 0 20 20" fill="currentColor" width="18" height="18">
          <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" *ngIf="emailModalTask">
      <div class="email-meta-grid">
        <div class="email-meta-item">
          <span class="meta-label">From</span>
          <span class="meta-value">{{ emailModalTask.fromName }} &lt;{{ emailModalTask.fromEmail }}&gt;</span>
        </div>
        <div class="email-meta-item">
          <span class="meta-label">Subject</span>
          <span class="meta-value">{{ emailModalTask.subject }}</span>
        </div>
        <div class="email-meta-item">
          <span class="meta-label">Date</span>
          <span class="meta-value">{{ emailModalTask.dateAdded | date:'dd MMM yyyy, HH:mm' }}</span>
        </div>
        <div class="email-meta-item">
          <span class="meta-label">Type</span>
          <span class="meta-value">{{ emailModalTask.taskType || emailModalTask.category }}</span>
        </div>
      </div>
      <div class="email-body-box">
        <p class="email-body-label">Message</p>
        <div class="email-body-content">{{ emailModalTask.emailBody || '(No body content)' }}</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" (click)="closeEmailPreview()">Close</button>
      <button class="btn-modal btn-modal-primary" (click)="closeEmailPreview(); openSendModal(emailModalTask!)">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" width="13" height="13">
          <polyline points="14,2 2,8 14,14"/><polyline points="2,8 8,8 8,14"/>
        </svg>Reply
      </button>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════════════
     MODAL — SEND EMAIL
══════════════════════════════════════════════════════════════════════════ -->
<div class="modal-backdrop" *ngIf="showSendModal" (click)="closeSendModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" width="18" height="18">
          <line x1="2" y1="3" x2="13" y2="12"/><line x1="2" y1="17" x2="13" y2="12"/>
          <polyline points="5,3 18,3 18,17 5,17"/>
        </svg>Send Email
      </h3>
      <button class="modal-close" (click)="closeSendModal()">
        <svg viewBox="0 0 20 20" fill="currentColor" width="18" height="18">
          <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <label class="modal-label">To</label>
        <input type="email" class="modal-input" [(ngModel)]="sendToEmail"
          placeholder="recipient@example.com" [disabled]="(isSendingEmail$ | async) === true" />
      </div>
      <div class="modal-field">
        <label class="modal-label">Subject</label>
        <input type="text" class="modal-input" [(ngModel)]="sendSubject"
          placeholder="Subject…" [disabled]="(isSendingEmail$ | async) === true" />
      </div>
      <div class="modal-field">
        <label class="modal-label">Message <span class="required">*</span></label>
        <textarea class="modal-input modal-textarea" [(ngModel)]="sendBody"
          placeholder="Type your message…" rows="6" [disabled]="(isSendingEmail$ | async) === true"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" (click)="closeSendModal()"
        [disabled]="(isSendingEmail$ | async) === true">Cancel</button>
      <button class="btn-modal btn-modal-primary" (click)="sendEmail()"
        [disabled]="!sendBody.trim() || (isSendingEmail$ | async) === true">
        <span *ngIf="(isSendingEmail$ | async) === false">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" width="13" height="13" style="vertical-align:middle;margin-right:4px">
            <line x1="15" y1="1" x2="6" y2="10"/><polygon points="15,1 10,15 6,10 1,6"/>
          </svg>Send Email
        </span>
        <span *ngIf="(isSendingEmail$ | async) === true"><span class="spinner-inline"></span> Sending…</span>
      </button>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════════════
     MODAL — EDIT ENQUIRY  (email FIRST, then comments + send-on-update)
══════════════════════════════════════════════════════════════════════════ -->
<div class="modal-backdrop" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" width="16" height="16">
          <path d="M11.5 2.5a1.414 1.414 0 012 2L5 13H2v-3L11.5 2.5z"/>
        </svg>Edit Enquiry
      </h3>
      <button class="modal-close" (click)="closeEditModal()">
        <svg viewBox="0 0 20 20" fill="currentColor" width="18" height="18">
          <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
        </svg>
      </button>
    </div>

    <div class="modal-body" *ngIf="editingEnquiry">
      <!-- Email FIRST -->
      <div class="modal-field">
        <label class="modal-label">Customer Email</label>
        <input type="email" class="modal-input"
          [(ngModel)]="editEmail"
          placeholder="customer@example.com"
          [disabled]="(isSaving$ | async) === true" />
      </div>

      <!-- Comments second -->
      <div class="modal-field">
        <label class="modal-label">Comments <span class="required">*</span></label>
        <textarea class="modal-input modal-textarea"
          [(ngModel)]="editComments"
          rows="5"
          maxlength="2000"
          [disabled]="(isSaving$ | async) === true">
        </textarea>
        <span class="char-hint">{{ editComments.length }}/2000</span>
      </div>

      <!-- Send-on-update checkbox -->
      <div class="send-update-row">
        <label class="checkbox-label">
          <input type="checkbox"
            [(ngModel)]="sendEmailOnUpdate"
            [disabled]="!editEmail.trim() || (isSaving$ | async) === true" />
          <span>Send email notification to customer on update</span>
        </label>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" (click)="closeEditModal()"
        [disabled]="(isSaving$ | async) === true">Cancel</button>
      <button class="btn-modal btn-modal-primary" (click)="saveEdit()"
        [disabled]="!editComments.trim() || (isSaving$ | async) === true">
        <span *ngIf="(isSaving$ | async) === false">Save Changes</span>
        <span *ngIf="(isSaving$ | async) === true"><span class="spinner-inline"></span> Saving…</span>
      </button>
    </div>
  </div>
</div>