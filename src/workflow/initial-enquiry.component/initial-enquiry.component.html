<div class="initial-enquiry-container">

  <!-- â”€â”€ Follow-Up Context Banner (shown when navigated from Follow-Ups screen) â”€â”€ -->
  <div class="followup-banner" *ngIf="followUpBannerVisible$ | async">
    <div class="followup-banner-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
        <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
        <line x1="6" y1="1" x2="6" y2="4"/>
        <line x1="10" y1="1" x2="10" y2="4"/>
        <line x1="14" y1="1" x2="14" y2="4"/>
      </svg>
    </div>
    <div class="followup-banner-body">
      <strong>Follow-up needed.</strong>
      This enquiry has been waiting for more than 3 days without a reply.
      Add a new enquiry below (or send an email) â€” this will automatically reset the follow-up timer.
    </div>
    <button class="followup-banner-close" (click)="dismissFollowUpBanner()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>

  <!-- Success/Error Messages -->
  <div class="alert alert-success" *ngIf="successMessage$ | async as successMessage">
    {{ successMessage }}
  </div>
  <div class="alert alert-error" *ngIf="errorMessage$ | async as errorMessage">
    {{ errorMessage }}
  </div>

  <!-- Form Section with Tabs -->
  <div class="enquiry-form-section">
    <h2>{{ (isEditMode$ | async) ? 'Edit Initial Enquiry' : 'Add Initial Enquiry' }}</h2>
    
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button 
        type="button"
        class="tab-button" 
        [class.active]="(activeTab$ | async) === 'comments'"
        (click)="switchTab('comments')">
        Comments
      </button>
      <button 
        type="button"
        class="tab-button" 
        [class.active]="(activeTab$ | async) === 'email'"
        (click)="switchTab('email')">
        Email
      </button>
      <button 
        type="button"
        class="tab-button" 
        [class.active]="(activeTab$ | async) === 'images'"
        (click)="switchTab('images')">
        Images
      </button>
    </div>

    <!-- Comments Tab -->
    <div class="tab-content" *ngIf="(activeTab$ | async) === 'comments'">
      <form [formGroup]="enquiryForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="email">Email Address <span class="required">*</span></label>
          <input 
            type="email" 
            id="email" 
            formControlName="email" 
            class="form-control"
            [class.invalid]="email?.invalid && email?.touched"
            placeholder="customer@example.com"
          />
          <div class="error-message" *ngIf="email?.invalid && email?.touched">
            <span *ngIf="email?.errors?.['required']">Email is required</span>
            <span *ngIf="email?.errors?.['email']">Please enter a valid email address</span>
          </div>
        </div>

        <div class="form-group">
          <label for="comments">Comments <span class="required">*</span></label>
          <textarea 
            id="comments" 
            formControlName="comments" 
            class="form-control"
            [class.invalid]="comments?.invalid && comments?.touched"
            rows="5"
            placeholder="Enter enquiry details, requirements, or any specific questions..."
          ></textarea>
          <div class="error-message" *ngIf="comments?.invalid && comments?.touched">
            <span *ngIf="comments?.errors?.['required']">Comments are required</span>
            <span *ngIf="comments?.errors?.['minlength']">Comments must be at least 10 characters</span>
          </div>
        </div>

        <div class="form-actions">
          <button 
            type="submit" 
            class="btn btn-primary" 
            [disabled]="(isLoading$ | async) === true"
          >
            <span *ngIf="!(isLoading$ | async)">{{ (isEditMode$ | async) ? 'Update Enquiry' : 'Add Enquiry' }}</span>
            <span *ngIf="isLoading$ | async">Processing...</span>
          </button>
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="cancelEdit()"
            *ngIf="isEditMode$ | async"
            [disabled]="(isLoading$ | async) === true"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>

    <!-- Email Tab -->
    <div class="tab-content" *ngIf="(activeTab$ | async) === 'email'">
      <form [formGroup]="emailForm">
        <div class="form-group">
          <label for="emailTemplate">Choose Email Template</label>
          <select 
            id="emailTemplate" 
            class="form-control"
            formControlName="template"
            (change)="onTemplateSelect($event)">
            <option value="">Select a template...</option>
            <option *ngFor="let template of emailTemplates$ | async" [value]="template.id">
              {{ template.name }}
            </option>
          </select>
        </div>

        <div class="form-group" *ngIf="emailSubject$ | async as emailSubject">
          <label for="emailSubject">Subject</label>
          <input 
            type="text" 
            id="emailSubject" 
            class="form-control"
            formControlName="subject"
            [value]="emailSubject"
            readonly
          />
        </div>

        <div class="form-group" *ngIf="emailContent$ | async as emailContent">
          <label for="emailBody">Email Content</label>
          <textarea 
            id="emailBody" 
            class="form-control email-template-body"
            formControlName="body"
            rows="15"
            placeholder="Email template will appear here"
            [value]="emailContent"
          ></textarea>
        </div>

        <div class="form-actions" *ngIf="emailContent$ | async">
          <button 
            type="button" 
            class="btn btn-primary" 
            (click)="sendEmail()"
            [disabled]="(isLoading$ | async) === true">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            Send Email
          </button>
        </div>
      </form>
    </div>

    <!-- Images Tab -->
    <div class="tab-content" *ngIf="(activeTab$ | async) === 'images'">
      <form [formGroup]="enquiryForm">
        <div class="form-group">
          <label for="images">Images (URLs or file references)</label>
          <input 
            type="text" 
            id="images" 
            formControlName="images" 
            class="form-control"
            placeholder="Enter image URLs or file paths"
          />
          <small class="form-hint">Optional: Add references to related images or documents</small>
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-primary" 
            (click)="onSubmit()"
            [disabled]="(isLoading$ | async) === true">
            Save Images
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ENQUIRY HISTORY â€” records saved to the DB for this workflow
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="enquiry-history-section" *ngIf="(enquiries$ | async)?.length as enqCount">
    <div class="section-header">
      <h2>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        Enquiry History
        <span class="history-count">{{ enqCount }}</span>
      </h2>
    </div>

    <table class="history-table">
      <thead>
        <tr>
          <th class="hcol-date">Date</th>
          <th class="hcol-email">Email</th>
          <th class="hcol-comments">Comments</th>
          <th class="hcol-source">Source</th>
          <th class="hcol-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let enq of enquiries$ | async" class="history-row">
          <td class="hcol-date">{{ formatDate(enq.dateCreated) }}</td>
          <td class="hcol-email">{{ enq.email }}</td>
          <td class="hcol-comments">
            <span class="enq-comments" [title]="enq.comments">{{ enq.comments }}</span>
          </td>
          <td class="hcol-source">
            <!-- Email-linked badge: shown when this record was created from an inbound email -->
            <span class="source-badge source-email" *ngIf="enq.incomingEmailId || enq.taskId"
                  title="Created automatically from an inbound email">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              Email
            </span>
            <!-- Manual badge: shown when entered by a user -->
            <span class="source-badge source-manual" *ngIf="!enq.incomingEmailId && !enq.taskId"
                  title="Entered manually">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
              </svg>
              Manual
            </span>
          </td>
          <td class="hcol-actions">
            <button class="btn-edit-enq" (click)="editEnquiry(enq)" title="Edit this enquiry">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              Edit
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INCOMING INITIAL ENQUIRY EMAILS â€” split-pane: grid left, viewer right
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="email-inbox-section">

    <!-- Section header -->
    <div class="inbox-header">
      <h2>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        Initial Enquiry Emails
        <span class="inbox-count" *ngIf="(incomingEmails$ | async)?.length as n">{{ n }}</span>
      </h2>
      <button class="btn-refresh" (click)="loadIncomingEmails()" [disabled]="isEmailsLoading$ | async">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          [class.spinning]="isEmailsLoading$ | async">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        Refresh
      </button>
    </div>

    <!-- Split pane wrapper -->
    <div class="inbox-split" [class.has-viewer]="selectedEmail$ | async">

      <!-- â”€â”€ LEFT: Email list â”€â”€ -->
      <div class="inbox-list-pane">

        <!-- Loading -->
        <div *ngIf="isEmailsLoading$ | async" class="loading-state">
          <div class="spinner"></div>
          <p>Loading emails...</p>
        </div>

        <!-- Empty -->
        <div *ngIf="!(isEmailsLoading$ | async) && (incomingEmails$ | async)?.length === 0" class="empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
          <h3>No Enquiry Emails</h3>
          <p>Emails categorised as Initial Enquiry will appear here.</p>
        </div>

        <!-- Grid table -->
        <table class="email-grid" *ngIf="!(isEmailsLoading$ | async) && (incomingEmails$ | async)?.length! > 0">
          <thead>
            <tr>
              <th class="col-from">From</th>
              <th class="col-subject">Subject</th>
              <th class="col-date">Received</th>
              <th class="col-status">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let email of incomingEmails$ | async"
              class="email-row"
              [class.selected]="(selectedEmail$ | async)?.id === email.id"
              (click)="selectEmail(email)">

              <!-- From -->
              <td class="col-from">
                <div class="sender-avatar">{{ (email.fromName || email.fromEmail)[0].toUpperCase() }}</div>
                <div class="sender-info">
                  <span class="sender-name">{{ email.fromName || email.fromEmail }}</span>
                  <span class="sender-email">{{ email.fromEmail }}</span>
                </div>
              </td>

              <!-- Subject + preview -->
              <td class="col-subject">
                <span class="email-subject">{{ email.subject }}</span>
                <span class="email-preview">{{ stripHtml(email.bodyPreview) }}</span>
              </td>

              <!-- Date -->
              <td class="col-date">{{ formatDate(email.receivedDateTime) }}</td>

              <!-- Status -->
              <td class="col-status">
                <span class="status-pill"
                  [class.pill-completed]="email.processingStatus === 'Completed'"
                  [class.pill-pending]="email.processingStatus === 'Pending'"
                  [class.pill-failed]="email.processingStatus === 'Failed'">
                  {{ email.processingStatus }}
                </span>
                <span class="attach-icon" *ngIf="email.hasAttachments" title="Has attachments">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                  </svg>
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- â”€â”€ RIGHT: Email viewer â”€â”€ -->
      <div class="inbox-viewer-pane" *ngIf="selectedEmail$ | async as selected">

        <!-- Viewer header -->
        <div class="viewer-header">
          <div class="viewer-meta">
            <h3 class="viewer-subject">{{ selected.subject }}</h3>
            <div class="viewer-from">
              <strong>From:</strong> {{ selected.fromName }} &lt;{{ selected.fromEmail }}&gt;
            </div>
            <div class="viewer-date">
              <strong>Received:</strong> {{ formatDate(selected.receivedDateTime) }}
            </div>
            <div class="viewer-status">
              <strong>Status:</strong>
              <span class="status-pill"
                [class.pill-completed]="selected.processingStatus === 'Completed'"
                [class.pill-pending]="selected.processingStatus === 'Pending'"
                [class.pill-failed]="selected.processingStatus === 'Failed'">
                {{ selected.processingStatus }}
              </span>
              <span class="attach-badge" *ngIf="selected.hasAttachments">
                ðŸ“Ž {{ selected.attachmentCount }} attachment{{ selected.attachmentCount !== 1 ? 's' : '' }}
              </span>
            </div>
          </div>
          <button class="btn-close-viewer" (click)="closeEmailViewer()" title="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <!-- Body loading -->
        <div *ngIf="isEmailDetailLoading$ | async" class="loading-state viewer-loading">
          <div class="spinner"></div>
          <p>Loading email content...</p>
        </div>

        <!-- Rendered HTML body -->
        <div class="viewer-body" *ngIf="!(isEmailDetailLoading$ | async) && (selectedEmailHtml$ | async) as safeHtml">
          <div class="email-html-frame" [innerHTML]="safeHtml"></div>
        </div>
      </div>

    </div><!-- /inbox-split -->
  </div><!-- /email-inbox-section -->

</div><!-- /initial-enquiry-container -->