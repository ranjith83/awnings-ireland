<div class="workflow-container">
  <form [formGroup]="this.bookingForm" class="booking-form">
    <div class="quote-content">
      <!-- Loading Overlay -->
      <div *ngIf="isLoading" class="loading-overlay">
        <div class="spinner"></div>
        <p>Processing...</p>
      </div>
      
      <!-- Success/Error Messages -->
      <div *ngIf="successMessage" class="alert alert-success">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        {{ successMessage }}
      </div>
      
      <div *ngIf="errorMessage" class="alert alert-error">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        {{ errorMessage }}
      </div>

      <!-- Select Workflow Section -->
      <div class="form-section">
        <h2 class="section-title">Select Workflow & Event Details</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="workflow">Select Workflow</label>
            <select id="workflow" formControlName="workflow" class="form-control" (change)="onWorkflowSelectionChange()">
              <option value="">Select a workflow</option>
              <option *ngFor="let workflow of workflows" [value]="workflow.id">
                {{ workflow.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="eventName">Event Name <span class="required">*</span></label>
            <input 
              type="text"
              id="eventName"
              formControlName="eventName"
              class="form-control"
              placeholder="e.g., Product Demo - John Smith">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="description">Description</label>
            <input 
              type="text"
              id="description"
              formControlName="description"
              class="form-control"
              placeholder="Additional notes or details (optional)">
          </div>
        </div>
      </div>

      <!-- Booking Form Section -->
      <div class="form-section">
        <h2 class="section-title">Appointment Details</h2>

        <!-- Event Date -->
        <div class="form-group">
          <label>Event Date:</label>
          
          <div class="calendar-container">
            <div class="calendar-header">
              <button type="button" class="nav-btn" (click)="previousMonth()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                </svg>
              </button>
              <span class="month-year">{{ getMonthYear() }}</span>
              <button type="button" class="nav-btn" (click)="nextMonth()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </button>
            </div>

            <div class="calendar-grid">
              <div *ngFor="let day of weekDays" class="calendar-weekday">
                {{ day }}
              </div>
              <button
                *ngFor="let day of calendarDays"
                type="button"
                class="calendar-day"
                [class.selected]="isSelectedDate(day)"
                [class.has-events]="hasEvents(day)"
                [class.empty]="day === null"
                [disabled]="day === null"
                (click)="selectDate(day)">
                <span class="day-number">{{ day }}</span>
                
                <!-- Show first event if exists -->
                <div *ngIf="hasEvents(day)" class="day-events">
                  <div class="event-preview" [title]="getFirstEventForDay(day)?.subject">
                    {{ getFirstEventForDay(day)?.subject }}
                  </div>
                  
                  <!-- Show "X more" if more than 1 event -->
                  <button 
                    *ngIf="getEventCountForDay(day) > 1" 
                    type="button"
                    class="more-events-btn"
                    (click)="showMoreEvents(day, $event)">
                    +{{ getEventCountForDay(day) - 1 }} more
                  </button>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Events List for Selected Date -->
        <div *ngIf="eventsForSelectedDate.length > 0" class="events-section">
          <div class="events-header">
            <h3>Events on {{ selectedDate | date:'MMM d, yyyy' }}</h3>
            <button type="button" class="btn-toggle" (click)="toggleEventsList()">
              <svg *ngIf="!showEventsList" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 4a.5.5 0 01.5.5v3h3a.5.5 0 010 1h-3v3a.5.5 0 01-1 0v-3h-3a.5.5 0 010-1h3v-3A.5.5 0 018 4z"/>
              </svg>
              <svg *ngIf="showEventsList" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4 8a.5.5 0 01.5-.5h7a.5.5 0 010 1h-7A.5.5 0 014 8z"/>
              </svg>
            </button>
          </div>
          
          <div *ngIf="showEventsList" class="events-list">
            <div *ngFor="let event of eventsForSelectedDate" class="event-item">
              <div class="event-info">
                <h4>{{ event.subject }}</h4>
                <p class="event-time">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 3.5a.5.5 0 00-1 0V9a.5.5 0 00.252.434l3.5 2a.5.5 0 00.496-.868L8 8.71V3.5z"/>
                    <path d="M8 16A8 8 0 108 0a8 8 0 000 16zm7-8A7 7 0 111 8a7 7 0 0114 0z"/>
                  </svg>
                  {{ formatEventTime(event.start.dateTime) }} - {{ formatEventTime(event.end.dateTime) }}
                </p>
                <p *ngIf="event.location?.displayName" class="event-location">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 16s6-5.686 6-10A6 6 0 002 6c0 4.314 6 10 6 10zm0-7a3 3 0 110-6 3 3 0 010 6z"/>
                  </svg>
                  {{ event.location?.displayName }}
                </p>
                <p *ngIf="event.attendees && event.attendees.length > 0" class="event-attendees">
                  <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M11 6a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path fill-rule="evenodd" d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-7a7 7 0 00-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 008 1z"/>
                  </svg>
                  {{ event.attendees[0].emailAddress.name || event.attendees[0].emailAddress.address }}
                </p>
              </div>
              <button 
                type="button" 
                class="btn-delete"
                (click)="confirmDeleteEvent(event.id, event.subject)"
                title="Delete event">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M5.5 5.5A.5.5 0 016 6v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm2.5 0a.5.5 0 01.5.5v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm3 .5a.5.5 0 00-1 0v6a.5.5 0 001 0V6z"/>
                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 01-1 1H13v9a2 2 0 01-2 2H5a2 2 0 01-2-2V4h-.5a1 1 0 01-1-1V2a1 1 0 011-1H6a1 1 0 011-1h2a1 1 0 011 1h3.5a1 1 0 011 1v1zM4.118 4L4 4.059V13a1 1 0 001 1h6a1 1 0 001-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Time Slot and Duration Section -->
        <div class="form-section">
          <h3 class="section-title">Select Time</h3>
          <div class="form-row">
            <!-- Start Time -->
            <div class="form-group">
              <label for="startTime">Start Time <span class="required">*</span></label>
              <select 
                id="startTime"
                formControlName="startTime"
                class="form-control"
                (change)="onStartTimeChange()">
                <option value="" disabled>Select start time</option>
                <option 
                  *ngFor="let time of timeSlots" 
                  [value]="time"
                  [disabled]="!isStartTimeAvailable(time)">
                  {{ time }} {{ !isStartTimeAvailable(time) ? '(Booked)' : '' }}
                </option>
              </select>
              <small *ngIf="!selectedDate" class="form-hint">Please select a date first</small>
            </div>

            <!-- End Time -->
            <div class="form-group">
              <label for="endTime">End Time <span class="required">*</span></label>
              <select 
                id="endTime"
                formControlName="endTime"
                class="form-control"
                (change)="onEndTimeChange()">
                <option value="" disabled>Select end time</option>
                <option 
                  *ngFor="let time of availableEndTimeSlots" 
                  [value]="time">
                  {{ time }}
                </option>
              </select>
              <small *ngIf="!selectedStartTime" class="form-hint">Please select start time first</small>
              <small *ngIf="selectedStartTime && availableEndTimeSlots.length === 0" class="form-hint warning">
                No available end times. There's an event scheduled immediately after.
              </small>
            </div>
          </div>
        </div>

        <!-- Email Client Checkbox -->
        <div class="form-section">
          <div class="checkbox-group">
            <label class="checkbox-label large">
              <input 
                type="checkbox"
                formControlName="emailClient"
                class="checkbox-input">
              <span>Email Client Appointment Confirmation</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="onClose()" [disabled]="isLoading">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4.646 4.646a.5.5 0 01.708 0L8 7.293l2.646-2.647a.5.5 0 01.708.708L8.707 8l2.647 2.646a.5.5 0 01-.708.708L8 8.707l-2.646 2.647a.5.5 0 01-.708-.708L7.293 8 4.646 5.354a.5.5 0 010-.708z"/>
          </svg>
          Close
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="onSave()"
          [disabled]="!bookingForm.valid || isLoading">
          <svg *ngIf="!isLoading" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M13.854 3.646a.5.5 0 010 .708l-7 7a.5.5 0 01-.708 0l-3.5-3.5a.5.5 0 11.708-.708L6.5 10.293l6.646-6.647a.5.5 0 01.708 0z"/>
          </svg>
          <svg *ngIf="isLoading" class="spinner" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0a8 8 0 100 16A8 8 0 008 0zM7 12.5v-9a.5.5 0 011 0v9a.5.5 0 01-1 0z"/>
          </svg>
          {{ isLoading ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </div>
  </form>

  <!-- Delete Confirmation Dialog -->
  <div *ngIf="showDeleteConfirmation" class="popup-overlay" (click)="cancelDelete()">
    <div class="confirmation-dialog" (click)="$event.stopPropagation()">
      <div class="confirmation-header">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
          <circle cx="24" cy="24" r="24" fill="#fee"/>
          <path d="M24 14v12M24 30h.01" stroke="#dc3545" stroke-width="3" stroke-linecap="round"/>
        </svg>
        <h3>Confirm Delete</h3>
      </div>
      
      <div class="confirmation-content">
        <p>Are you sure you want to delete this event?</p>
        <p class="event-name-to-delete">"{{ deletingEventName }}"</p>
        <p class="warning-text">This action cannot be undone.</p>
      </div>
      
      <div class="confirmation-actions">
        <button type="button" class="btn btn-secondary" (click)="cancelDelete()">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" (click)="deleteEvent()">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M5.5 5.5A.5.5 0 016 6v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm2.5 0a.5.5 0 01.5.5v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm3 .5a.5.5 0 00-1 0v6a.5.5 0 001 0V6z"/>
            <path fill-rule="evenodd" d="M14.5 3a1 1 0 01-1 1H13v9a2 2 0 01-2 2H5a2 2 0 01-2-2V4h-.5a1 1 0 01-1-1V2a1 1 0 011-1H6a1 1 0 011-1h2a1 1 0 011 1h3.5a1 1 0 011 1v1zM4.118 4L4 4.059V13a1 1 0 001 1h6a1 1 0 001-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
          </svg>
          Delete Event
        </button>
      </div>
    </div>
  </div>
  
  <!-- Events Popup Modal -->
  <div *ngIf="showEventsPopup" class="popup-overlay" (click)="closeEventsPopup()">
    <div class="popup-modal" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>Events on {{ popupDate | date:'MMM d, yyyy' }}</h3>
        <button type="button" class="popup-close" (click)="closeEventsPopup()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M4.646 4.646a.5.5 0 01.708 0L10 9.293l4.646-4.647a.5.5 0 01.708.708L10.707 10l4.647 4.646a.5.5 0 01-.708.708L10 10.707l-4.646 4.647a.5.5 0 01-.708-.708L9.293 10 4.646 5.354a.5.5 0 010-.708z"/>
          </svg>
        </button>
      </div>
      
      <div class="popup-content">
        <div *ngFor="let event of popupEvents" class="popup-event-item">
          <div class="event-info">
            <h4>{{ event.subject }}</h4>
            <p class="event-time">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 3.5a.5.5 0 00-1 0V9a.5.5 0 00.252.434l3.5 2a.5.5 0 00.496-.868L8 8.71V3.5z"/>
                <path d="M8 16A8 8 0 108 0a8 8 0 000 16zm7-8A7 7 0 111 8a7 7 0 0114 0z"/>
              </svg>
              {{ formatEventTime(event.start.dateTime) }} - {{ formatEventTime(event.end.dateTime) }}
            </p>
            <p *ngIf="event.location?.displayName" class="event-location">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 16s6-5.686 6-10A6 6 0 002 6c0 4.314 6 10 6 10zm0-7a3 3 0 110-6 3 3 0 010 6z"/>
              </svg>
              {{ event.location?.displayName }}
            </p>
            <p *ngIf="event.attendees && event.attendees.length > 0" class="event-attendees">
              <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                <path d="M11 6a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path fill-rule="evenodd" d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-7a7 7 0 00-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 008 1z"/>
              </svg>
              {{ event.attendees[0].emailAddress.name || event.attendees[0].emailAddress.address }}
            </p>
          </div>
          <button 
            type="button" 
            class="btn-delete"
            (click)="confirmDeleteEvent(event.id, event.subject)"
            title="Delete event">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M5.5 5.5A.5.5 0 016 6v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm2.5 0a.5.5 0 01.5.5v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm3 .5a.5.5 0 00-1 0v6a.5.5 0 001 0V6z"/>
              <path fill-rule="evenodd" d="M14.5 3a1 1 0 01-1 1H13v9a2 2 0 01-2 2H5a2 2 0 01-2-2V4h-.5a1 1 0 01-1-1V2a1 1 0 011-1H6a1 1 0 011-1h2a1 1 0 011 1h3.5a1 1 0 011 1v1zM4.118 4L4 4.059V13a1 1 0 001 1h6a1 1 0 001-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>