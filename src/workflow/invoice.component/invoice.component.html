<div class="create-invoice-container">
  <!-- Loading & Messages -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <div class="invoice-content">
    <!-- Select Workflow and Quote -->
    <div class="form-section">
      <h3 class="section-title">Select Workflow & Quote</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Select Workflow</label>
          <select class="form-select" [(ngModel)]="selectedWorkflowId" (change)="onWorkflowChange()">
            <option [value]="null" disabled>Select Workflow</option>
            <option *ngFor="let workflow of workflows" [value]="workflow.workflowId">
              {{ workflow.workflowName || 'Workflow #' + workflow.workflowId }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Product Model</label>
          <input 
            type="text" 
            class="form-input" 
            [(ngModel)]="selectedProductName" 
            readonly
            placeholder="Product will be displayed here">
        </div>

        <div class="form-group">
          <label class="form-label">Select Quote</label>
          <select class="form-select" [(ngModel)]="selectedQuoteId" (change)="onQuoteChange()">
            <option [value]="null" disabled>Select Quote</option>
            <option *ngFor="let quote of quotes" [value]="quote.quoteId">
              {{ quote.quoteNumber }} - â‚¬{{ quote.totalAmount | number:'1.2-2' }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Select Dimensions -->
    <div class="form-section">
      <h3 class="section-title">Select Dimensions</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Widths in cm</label>
          <select class="form-select" [(ngModel)]="selectedWidthCm" (change)="onWidthChange()">
            <option [value]="null" disabled selected>Select</option>
            <option *ngFor="let width of availableWidths" [value]="width">
              {{ width }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Select Awning (Projection)</label>
          <select class="form-select" [(ngModel)]="selectedAwning" (change)="onAwningChange()">
            <option [value]="null" disabled selected>Select</option>
            <option *ngFor="let projection of availableProjections" [value]="projection">
              {{ projection }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Additional Addons -->
    <div class="form-section">
      <h3 class="section-title">Additional Addons</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Brackets</label>
          <select class="form-select" [(ngModel)]="selectedBrackets" (change)="onBracketChange()">
            <option value="" disabled selected>Select</option>
            <option *ngFor="let bracket of brackets" [value]="bracket.bracketId">
              {{ bracket.bracketName }} - â‚¬{{ bracket.price | number:'1.2-2' }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Arms</label>
          <select class="form-select" [(ngModel)]="selectedArms" (change)="onArmChange()">
            <option value="" disabled selected>Select</option>
            <option *ngFor="let arm of arms" [value]="arm.armId">
              {{ arm.description }} - â‚¬{{ arm.price | number:'1.2-2' }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Motor</label>
          <select class="form-select" [(ngModel)]="selectedMotor" (change)="onMotorChange()">
            <option value="" disabled selected>Select</option>
            <option *ngFor="let motor of motors" [value]="motor.motorId">
              {{ motor.description }} - â‚¬{{ motor.price | number:'1.2-2' }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Heater</label>
          <select class="form-select" [(ngModel)]="selectedHeater" (change)="onHeaterChange()">
            <option value="" disabled selected>Select</option>
            <option *ngFor="let heater of heaters" [value]="heater.heaterId">
              {{ heater.description }} - â‚¬{{ heater.price | number:'1.2-2' }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Invoice Details -->
    <div class="form-section">
      <h3 class="section-title">Invoice Details</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Invoice Date</label>
          <input 
            type="date" 
            class="form-input" 
            [(ngModel)]="invoiceDate">
        </div>

        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input 
            type="date" 
            class="form-input" 
            [(ngModel)]="dueDate">
        </div>

        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" [(ngModel)]="invoiceStatus">
            <option value="Draft">Draft</option>
            <option value="Sent">Sent</option>
            <option value="Paid">Paid</option>
            <option value="Overdue">Overdue</option>
            <option value="Cancelled">Cancelled</option>
            <option value="Partially Paid">Partially Paid</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Installation Fee -->
    <div class="form-section">
      <h3 class="section-title">Installation Fee</h3>
      <div class="form-row installation-row">
        <div class="form-group small">
          <label class="form-label">Fee</label>
          <input type="number" class="form-input" [(ngModel)]="installationFee" (ngModelChange)="onInstallationFeeChange()" placeholder="0.00">
        </div>
        <div class="vat-text">{{ vatRate }}% VAT</div>
      </div>
    </div>

    <!-- Invoice Items Table -->
    <div class="table-section">
      <div class="table-header">
        <h3>Invoice Items</h3>
        <button class="btn-add" (click)="addInvoiceItem()">+ Add Item</button>
      </div>
      <table class="invoice-table">
        <thead>
          <tr>
            <th>DESCRIPTION</th>
            <th>QUANTITY</th>
            <th>UNIT PRICE</th>
            <th>TAX</th>
            <th>AMOUNT EUR</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of invoiceItems; let i = index; let even = even" [class.even-row]="even">
            <td>{{ item.description }}</td>
            <td>
              <input 
                type="number" 
                class="qty-input" 
                [(ngModel)]="item.quantity"
                (ngModelChange)="onQuantityChange(item)"
                min="1">
            </td>
            <td>
              <input 
                type="number" 
                class="price-input" 
                [(ngModel)]="item.unitPrice"
                (ngModelChange)="onItemChange(item)"
                min="0"
                step="0.01">
            </td>
            <td>
              <input 
                type="number" 
                class="tax-input" 
                [(ngModel)]="item.taxRate"
                (ngModelChange)="onItemChange(item)"
                min="0"
                max="100"
                step="0.5">
            </td>
            <td>â‚¬{{ item.totalPrice | number:'1.2-2' }}</td>
            <td>
              <button class="btn-remove" (click)="removeInvoiceItem(i)" *ngIf="invoiceItems.length > 1">
                Remove
              </button>
            </td>
          </tr>
          <tr *ngIf="invoiceItems.length === 0">
            <td colspan="6" class="text-center">
              Select width and awning to generate first line item
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Summary Section -->
    <div class="summary-section">
      <div class="summary-left">
        <label class="checkbox-label large">
          <input type="checkbox" class="checkbox-input" [(ngModel)]="emailToCustomer">
          <span>Email Invoice to customer</span>
        </label>
        <div class="notes-section">
          <label class="form-label">Notes</label>
          <textarea 
            class="form-textarea" 
            [(ngModel)]="notes" 
            rows="3" 
            placeholder="Add notes..."></textarea>
        </div>
        <div class="terms-section">
          <label class="form-label">Terms</label>
          <textarea 
            class="form-textarea" 
            [(ngModel)]="terms" 
            rows="3" 
            placeholder="Payment terms..."></textarea>
        </div>
      </div>

      <div class="summary-right">
        <div class="summary-row">
          <span class="summary-label">Sub Total</span>
          <span class="summary-value">â‚¬{{ subtotal | number:'1.2-2' }}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Total Sales TAX {{ vatRate }}%</span>
          <span class="summary-value">â‚¬{{ totalTax | number:'1.2-2' }}</span>
        </div>
        <div class="summary-row total">
          <span class="summary-label">Total EUR</span>
          <span class="summary-value">â‚¬{{ totalAmount | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-close" (click)="close()">
        <span class="close-icon">âœ•</span>
        Close
      </button>
      <button class="btn-generate" (click)="generateInvoice()" [disabled]="!isFormValid()">
        <span class="generate-icon">ðŸ”„</span>
        Generate Invoice
      </button>
    </div>
  </div>
</div>