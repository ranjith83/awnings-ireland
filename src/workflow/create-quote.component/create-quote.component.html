<div class="create-quote-container">

  <!-- Loading & Messages -->
  <div *ngIf="isLoading$ | async" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <div *ngIf="errorMessage$ | async as errorMessage" class="alert alert-error">{{ errorMessage }}</div>
  <div *ngIf="successMessage$ | async as successMessage" class="alert alert-success">{{ successMessage }}</div>

  <div class="quote-content">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKFLOW & PRODUCT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="form-section">
      <h3 class="section-title">Select Workflow &amp; Product</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Select Workflow</label>
          <select class="form-select" [(ngModel)]="selectedWorkflowId" (change)="onWorkflowChange()">
            <option [value]="null" disabled>Select Workflow</option>
            <option *ngFor="let workflow of workflows$ | async" [value]="workflow.workflowId">
              {{ workflow.workflowName }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Product Model</label>
          <input type="text" class="form-input"
            [(ngModel)]="selectedProductName" readonly
            placeholder="Product will be displayed here">
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DIMENSIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="form-section">
      <h3 class="section-title">Select Dimensions</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Widths in cm</label>
          <select class="form-select" [(ngModel)]="selectedWidthCm" (change)="onWidthChange()">
            <option [value]="null" disabled selected>Select</option>
            <option *ngFor="let width of availableWidths$ | async" [value]="width">{{ width }}</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Select Awning (Projection)</label>
          <select class="form-select" [(ngModel)]="selectedAwning" (change)="onAwningChange()">
            <option [value]="null" disabled selected>Select</option>
            <option *ngFor="let projection of availableProjections$ | async" [value]="projection">{{ projection }}</option>
          </select>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADDONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="form-section">
      <h3 class="section-title">Additional Addons</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Brackets</label>
          <select class="form-select" [(ngModel)]="selectedBrackets" (change)="onBracketChange()">
            <option value="" disabled selected>Select</option>
            <option *ngFor="let bracket of brackets$ | async" [value]="bracket.bracketId">
              {{ bracket.bracketName }} - â‚¬{{ bracket.price | number:'1.2-2' }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Arms</label>
          <select class="form-select" [(ngModel)]="selectedArms" (change)="onArmChange()">
            <option value="" disabled selected>Select</option>
            <option *ngFor="let arm of arms$ | async" [value]="arm.armId">
              {{ arm.description }} - â‚¬{{ arm.price | number:'1.2-2' }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Motor</label>
          <select class="form-select" [(ngModel)]="selectedMotor" (change)="onMotorChange()">
            <option value="" disabled selected>Select</option>
            <option *ngFor="let motor of motors$ | async" [value]="motor.motorId">
              {{ motor.description }} - â‚¬{{ motor.price | number:'1.2-2' }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Heater</label>
          <select class="form-select" [(ngModel)]="selectedHeater" (change)="onHeaterChange()">
            <option value="" disabled selected>Select</option>
            <option *ngFor="let heater of heaters$ | async" [value]="heater.heaterId">
              {{ heater.description }} - â‚¬{{ heater.price | number:'1.2-2' }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-row" style="margin-top:15px;">
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" class="checkbox-input"
              [(ngModel)]="includeElectrician" (change)="onElectricianChange()">
            <span>Electric connection by our Qualified Electrician - â‚¬{{ electricianPrice | number:'1.2-2' }}</span>
          </label>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUPPLY AND FIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="form-section">
      <h3 class="section-title">Supply and Fit</h3>
      <div class="form-row installation-row">
        <div class="form-group small">
          <label class="form-label">Fee</label>
          <input type="number" class="form-input"
            [(ngModel)]="installationFee"
            (ngModelChange)="onInstallationFeeChange()"
            placeholder="0.00">
        </div>
        <div class="vat-text">{{ vatRate }}% VAT</div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• QUOTE ITEMS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="table-section">
      <div class="table-header">
        <h3>Quote Items</h3>
        <button class="btn-add" (click)="addQuoteItem()">+ Add Item</button>
      </div>
      <table class="quote-table">
        <thead>
          <tr>
            <th>DESCRIPTION</th>
            <th>QUANTITY</th>
            <th>UNIT PRICE</th>
            <th>TAX</th>
            <th>AMOUNT EUR</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of quoteItems$ | async; let i = index; let even = even" [class.even-row]="even">
            <td>{{ item.description }}</td>
            <td>
              <input type="number" class="qty-input"
                [(ngModel)]="item.quantity" (ngModelChange)="onQuantityChange(item)" min="1">
            </td>
            <td>
              <input type="number" class="price-input"
                [(ngModel)]="item.unitPrice" (ngModelChange)="onItemChange(item)" min="0" step="0.01">
            </td>
            <td>
              <input type="number" class="tax-input"
                [(ngModel)]="item.taxRate" (ngModelChange)="onItemChange(item)" min="0" max="100" step="0.5">
            </td>
            <td>â‚¬{{ item.amount | number:'1.2-2' }}</td>
            <td>
              <button class="btn-remove" (click)="removeQuoteItem(i)"
                *ngIf="(quoteItems$ | async)?.length || 0 > 1">Remove</button>
            </td>
          </tr>
          <tr *ngIf="(quoteItems$ | async)?.length === 0">
            <td colspan="6" class="text-center">Select width and awning to generate first line item</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DISCOUNT (OPTIONAL) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="form-section">
      <h3 class="section-title">
        Quote Discount
        <span class="optional-tag">Optional</span>
      </h3>
      <p class="section-hint">Leave the discount type as "No Discount" to skip this section.</p>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Discount Type</label>
          <select class="form-select" [(ngModel)]="discountType" (change)="onDiscountChange()">
            <option value="">No Discount</option>
            <option value="Percentage">Percentage (%)</option>
            <option value="Fixed">Fixed Amount (â‚¬)</option>
          </select>
        </div>

        <!-- Only show value input when a discount type is chosen -->
        <div class="form-group" *ngIf="discountType">
          <label class="form-label">
            {{ discountType === 'Percentage' ? 'Discount Percentage (%)' : 'Discount Amount (â‚¬)' }}
          </label>
          <input type="number" class="form-input"
            [(ngModel)]="discountValue"
            (ngModelChange)="onDiscountChange()"
            [placeholder]="discountType === 'Percentage' ? 'e.g. 10' : 'e.g. 50.00'"
            min="0"
            [max]="discountType === 'Percentage' ? 100 : 999999"
            step="0.01">
        </div>

        <!-- Preview discount amount when both are set -->
        <div class="discount-preview" *ngIf="discountType && discountValue > 0">
          <span class="discount-preview-label">Discount Amount</span>
          <span class="discount-preview-value">-â‚¬{{ quoteDiscount$ | async | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUMMARY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="summary-section">
      <div class="summary-left">

        <!-- Email to customer â€” shows actual email address -->
        <div class="email-customer-block">
          <label class="checkbox-label large">
            <input type="checkbox" class="checkbox-input" [(ngModel)]="emailToCustomer">
            <span>Email Quote to customer</span>
          </label>

          <div class="email-address-row" *ngIf="emailToCustomer">
            
            <span class="email-address-text" *ngIf="customerEmail; else noEmail">
              {{ customerEmail }}
            </span>
            <ng-template #noEmail>
              <span class="email-address-missing">No email address on record</span>
            </ng-template>

            <span class="sending-indicator" *ngIf="isSendingEmail$ | async">
              <span class="spinner-tiny"></span> Sendingâ€¦
            </span>
          </div>
        </div>

        <button class="attach-btn">Attach Brochure with email</button>
      </div>

      <div class="summary-right">
        <div class="summary-row">
          <span class="summary-label">Sub Total</span>
          <span class="summary-value">â‚¬{{ subtotal$ | async | number:'1.2-2' }}</span>
        </div>
        <div class="summary-row" *ngIf="(quoteDiscount$ | async)! > 0">
          <span class="summary-label">
            Discount{{ discountType === 'Percentage' ? ' (' + discountValue + '%)' : '' }}
          </span>
          <span class="summary-value discount-value">-â‚¬{{ quoteDiscount$ | async | number:'1.2-2' }}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Total Sales TAX {{ vatRate }}%</span>
          <span class="summary-value">â‚¬{{ totalTax$ | async | number:'1.2-2' }}</span>
        </div>
        <div class="summary-row total">
          <span class="summary-label">Total EUR</span>
          <span class="summary-value">â‚¬{{ totalAmount$ | async | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACTION BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="action-buttons">
      <button class="btn-close" (click)="close()">
        <span class="close-icon">âœ•</span>
        Close
      </button>
      <button class="btn-generate" (click)="generateQuote()"
        [disabled]="(isFormValid$ | async) === false || (isLoading$ | async) === true">
        <span class="generate-icon"
          *ngIf="(isLoading$ | async) === false && (isSendingEmail$ | async) === false">ðŸ“„</span>
        <span class="spinner-btn"
          *ngIf="(isLoading$ | async) === true || (isSendingEmail$ | async) === true"></span>
        {{ (isLoading$ | async) ? 'Creatingâ€¦' : (isSendingEmail$ | async) ? 'Emailingâ€¦' : 'Generate Quote' }}
      </button>
    </div>

  </div>
</div>